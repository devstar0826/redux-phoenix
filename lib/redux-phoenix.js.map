{"version":3,"file":"redux-phoenix.js","sources":["../src/reduxPhoenix.js"],"sourcesContent":["import _ from 'lodash';\nimport moment from 'moment';\n\nexport const REHYDRATE = '@@REHYDRATE';\n\n/**\n * transform state according to passed transformation\n *\n * @param {object} map transformation\n * @param {object} state State from redux\n * @return {object} Transformed state\n */\nfunction transform(map, state) {\n  const result = {};\n  _.forEach(map, (value, key) => {\n    if (typeof value === 'function') {\n      const transformation = value(key, _.get(state, key), state);\n      if (transformation.targetKey && _.has(transformation, 'targetValue')) {\n        _.set(result, transformation.targetKey, transformation.targetValue);\n      }\n      if (_.has(transformation, 'sourceValue')) {\n        _.set(result, key, transformation.sourceValue);\n      }\n    } else {\n      _.set(result, value, _.get(state, key));\n    }\n  });\n  return _.merge({}, state, result);\n}\n\n/**\n * Persist store\n *\n * @export\n * @param {object} store Redux Store\n * @param {object} config Configuration object\n * @return {Promise<object>} Persisted Store\n */\nexport default function persistStore(store, {\n  key = 'redux',\n  whitelist = null,\n  blacklist = null,\n  storage = window.localStorage,\n  expireDate = null,\n  serialize = JSON.stringify,\n  deserialize = JSON.parse,\n  map = {},\n  disabled = false,\n  throttle = 0,\n} = {}) {\n  return Promise.resolve(storage.getItem(key)).then(persistedJson => {\n    if (disabled) {\n      return store;\n    }\n    const persistedValue = deserialize(persistedJson);\n    const { persistedState, saveDate } = persistedValue || {};\n    let state = persistedState;\n    if (expireDate && moment(saveDate).add(...expireDate).isBefore(moment())) {\n      state = {};\n    }\n    const persistedStateToMerge = whitelist\n      ? _.omit(_.pick(state, whitelist), blacklist)\n      : _.omit(state, blacklist);\n\n    store.dispatch({\n      type: REHYDRATE,\n      payload: persistedStateToMerge,\n    });\n\n    const saveState = () => {\n      const state = transform(map, store.getState());\n      const subset = whitelist\n        ? _.omit(_.pick(state, whitelist), blacklist)\n        : _.omit(state, blacklist);\n\n      storage.setItem(key, serialize({ persistedState: subset, saveDate: moment().valueOf() }));\n    };\n\n    const throttledSubscribe = _.throttle(saveState, throttle, {\n      trailing: true,\n    });\n    store.subscribe(throttle > 0 ? throttledSubscribe : saveState);\n    return store;\n  });\n}\n\n/**\n * Enhancer\n *\n * @export\n * @param {function} next callback\n * @return {function} enhancer\n */\nexport const autoRehydrate = next => (reducer, initialState, enhancer) => {\n  if (typeof initialState === 'function' && typeof enhancer === 'undefined') {\n    enhancer = initialState;\n    initialState = undefined; // eslint-disable-line no-undefined\n  }\n  function rehydrateReducer(state, action) {\n    if (action.type === REHYDRATE) {\n      return reducer(_.merge({}, state, action.payload), action);\n    }\n    return reducer(state, action);\n  }\n  return next(rehydrateReducer, initialState, enhancer);\n};\n"],"names":["REHYDRATE","transform","map","state","result","_","forEach","value","key","transformation","get","targetKey","has","set","targetValue","sourceValue","merge","persistStore","store","whitelist","blacklist","storage","window","localStorage","expireDate","serialize","JSON","stringify","deserialize","parse","disabled","throttle","Promise","resolve","getItem","then","persistedValue","persistedJson","persistedState","saveDate","add","isBefore","moment","persistedStateToMerge","omit","pick","dispatch","type","payload","saveState","getState","subset","setItem","valueOf","throttledSubscribe","trailing","subscribe","autoRehydrate","reducer","initialState","enhancer","undefined","rehydrateReducer","action","next"],"mappings":"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"}