{"version":3,"file":"redux-phoenix.js","sources":["../src/reduxPhoenix.js"],"sourcesContent":["import _ from 'lodash';\nimport moment from 'moment';\n\nexport const REHYDRATE = '@@REHYDRATE';\n\n/**\n * transform state according to passed transformation\n *\n * @param {object} map transformation\n * @param {object} state State from redux\n * @return {object} Transformed state\n */\nfunction transform(map, state) {\n  const result = {};\n  _.forEach(map, (value, key) => {\n    if (typeof value === 'function') {\n      const transformation = value(key, _.get(state, key), state);\n      if (transformation.targetKey && _.has(transformation, 'targetValue')) {\n        _.set(result, transformation.targetKey, transformation.targetValue);\n      }\n      if (_.has(transformation, 'sourceValue')) {\n        _.set(result, key, transformation.sourceValue);\n      }\n    } else {\n      _.set(result, value, _.get(state, key));\n    }\n  });\n  return _.merge({}, state, result);\n}\n\n/**\n * Persist store\n *\n * @export\n * @param {object} store Redux Store\n * @param {object} config Configuration object\n * @return {Promise<object>} Persisted Store\n */\nexport default function persistStore(\n  store,\n  {\n    key = 'redux',\n    whitelist = null,\n    blacklist = null,\n    storage = window.localStorage,\n    expireDate = null,\n    serialize = JSON.stringify,\n    deserialize = JSON.parse,\n    map = {},\n    throttle = 0,\n    disabled = false,\n  } = {},\n) {\n  return Promise.resolve(storage.getItem(key)).then(persistedJson => {\n    if (disabled) {\n      return store;\n    }\n    const persistedValue = deserialize(persistedJson);\n    const { persistedState, saveDate } = persistedValue || {};\n    let state = persistedState;\n    if (\n      expireDate &&\n      moment(saveDate)\n        .add(...expireDate)\n        .isBefore(moment())\n    ) {\n      state = {};\n    }\n    const persistedStateToMerge = whitelist\n      ? _.omit(_.pick(state, whitelist), blacklist)\n      : _.omit(state, blacklist);\n\n    store.dispatch({\n      type: REHYDRATE,\n      payload: persistedStateToMerge,\n    });\n    const throttledSubscribe = _.throttle(saveState, throttle, {\n      trailing: true,\n    });\n    store.subscribe(() =>\n      throttledSubscribe(\n        store,\n        map,\n        whitelist,\n        blacklist,\n        storage,\n        key,\n        serialize,\n      ),\n    );\n    return store;\n  });\n}\n\n/**\n * Save the state\n *\n * @export\n * @param {function} next callback\n * @return {function} enhancer\n */\nfunction saveState(store, map, whitelist, blacklist, storage, key, serialize) {\n  const state = transform(map, store.getState());\n  const subset = whitelist\n    ? _.omit(_.pick(state, whitelist), blacklist)\n    : _.omit(state, blacklist);\n\n  storage.setItem(\n    key,\n    serialize({ persistedState: subset, saveDate: moment().valueOf() }),\n  );\n}\n/**\n * Enhancer\n *\n * @export\n * @param {function} next callback\n * @return {function} enhancer\n */\nexport const autoRehydrate = next => (reducer, initialState, enhancer) => {\n  if (typeof initialState === 'function' && typeof enhancer === 'undefined') {\n    enhancer = initialState;\n    initialState = undefined; // eslint-disable-line no-undefined\n  }\n  function rehydrateReducer(state, action) {\n    if (action.type === REHYDRATE) {\n      return reducer(_.merge({}, state, action.payload), action);\n    }\n    return reducer(state, action);\n  }\n  return next(rehydrateReducer, initialState, enhancer);\n};\n"],"names":["REHYDRATE","transform","map","state","result","_","forEach","value","key","transformation","get","targetKey","has","set","targetValue","sourceValue","merge","persistStore","store","whitelist","blacklist","storage","window","localStorage","expireDate","serialize","JSON","stringify","deserialize","parse","throttle","disabled","Promise","resolve","getItem","then","persistedValue","persistedJson","persistedState","saveDate","add","isBefore","moment","persistedStateToMerge","omit","pick","dispatch","type","payload","throttledSubscribe","saveState","trailing","subscribe","getState","subset","setItem","valueOf","autoRehydrate","reducer","initialState","enhancer","undefined","rehydrateReducer","action","next"],"mappings":"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"}