{"version":3,"file":"redux-phoenix.js","sources":["../src/reduxPhoenix.js"],"sourcesContent":["import _ from 'lodash';\nimport moment from 'moment';\n\nexport const REHYDRATE = '@@REHYDRATE';\n\n/**\n * transform state according to passed transformation\n *\n * @param {object} map transformation\n * @param {object} state State from redux\n * @return {object} Transformed state\n */\nfunction transform(map, state) {\n  const result = {};\n  _.forEach(map, (value, key) => {\n    if (typeof value === 'function') {\n      const transformation = value(key, _.get(state, key), state);\n      if (transformation.targetKey && _.has(transformation, 'targetValue')) {\n        _.set(result, transformation.targetKey, transformation.targetValue);\n      }\n      if (_.has(transformation, 'sourceValue')) {\n        _.set(result, key, transformation.sourceValue);\n      }\n    } else {\n      _.set(result, value, _.get(state, key));\n    }\n  });\n  return _.merge({}, state, result);\n}\n\n/**\n * Persist store\n *\n * @export\n * @param {object} store Redux Store\n * @param {object} config Configuration object\n * @return {Promise<object>} Persisted Store\n */\nexport default function persistStore(store, {\n  key = 'redux',\n  whitelist = null,\n  blacklist = null,\n  storage = window.localStorage,\n  expireDate = null,\n  serialize = JSON.stringify,\n  deserialize = JSON.parse,\n  map = {},\n  disabled = false,\n} = {}) {\n  return Promise.resolve(storage.getItem(key)).then(persistedJson => {\n    if (disabled) {\n      return store;\n    }\n    const persistedValue = deserialize(persistedJson);\n    const { persistedState, saveDate } = persistedValue || {};\n    let state = persistedState;\n    if (expireDate && moment(saveDate).add(...expireDate).isBefore(moment())) {\n      state = {};\n    }\n    const persistedStateToMerge = whitelist\n      ? _.omit(_.pick(state, whitelist), blacklist)\n      : _.omit(state, blacklist);\n\n    store.dispatch({\n      type: REHYDRATE,\n      payload: persistedStateToMerge,\n    });\n\n    store.subscribe(function() {\n      const state = transform(map, store.getState());\n      const subset = whitelist\n        ? _.omit(_.pick(state, whitelist), blacklist)\n        : _.omit(state, blacklist);\n\n        storage.setItem(key, serialize({ persistedState: subset, saveDate: moment().valueOf() }));\n    });\n    return store;\n  });\n}\n\n/**\n * Enhancer\n *\n * @export\n * @param {function} next callback\n * @return {function} enhancer\n */\nexport const autoRehydrate = next => (reducer, initialState, enhancer) => {\n  if (typeof initialState === 'function' && typeof enhancer === 'undefined') {\n    enhancer = initialState;\n    initialState = undefined; // eslint-disable-line no-undefined\n  }\n  function rehydrateReducer(state, action) {\n    if (action.type === REHYDRATE) {\n      return reducer(_.merge({}, state, action.payload), action);\n    }\n    return reducer(state, action);\n  }\n  return next(rehydrateReducer, initialState, enhancer);\n};\n"],"names":["REHYDRATE","transform","map","state","result","_","forEach","value","key","transformation","get","targetKey","has","set","targetValue","sourceValue","merge","persistStore","store","whitelist","blacklist","storage","window","localStorage","expireDate","serialize","JSON","stringify","deserialize","parse","disabled","Promise","resolve","getItem","then","persistedValue","persistedJson","persistedState","saveDate","add","isBefore","moment","persistedStateToMerge","omit","pick","dispatch","type","payload","subscribe","getState","subset","setItem","valueOf","autoRehydrate","reducer","initialState","enhancer","undefined","rehydrateReducer","action","next"],"mappings":"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"}